<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib prefix="shiro" uri="http://shiro.apache.org/tags" %>
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <base href="<%=basePath%>">
    <title>代办任务</title>
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="expires" content="0">    
	<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
	<meta http-equiv="description" content="This is my page">
	<jsp:include page="../../layout/script.jsp"></jsp:include>
	<script type="text/javascript">
			var $dg;
			var $grid;
			$(function() {
				 $dg = $("#dg");
				 $grid=$dg.datagrid({
					url : "loanOrder/loanOrderAction!findAllUnClaimTask.action",
					width : 'auto',
					height : $(this).height()*0.96,
					pagination:true,
					rownumbers:true,
					border:true,
					singleSelect:true,
					nowrap:true,
					multiSort:false,
					columns : [ [ {field : 'name',title : '客户姓名',width : parseInt($(this).width()*0.06)},
					              {field : 'idNo',title : '身份证号',width : parseInt($(this).width()*0.1)},
					              {field : 'age',title : '年龄',width : parseInt($(this).width()*0.03)},
					              {field : 'annualSalary',title : '年收入(单位:万)',width : parseInt($(this).width()*0.06)},
					              {field : 'mortgageStatus',title : '居住情况',width : parseInt($(this).width()*0.1)},
					              {field : 'loanAmount',title : '申请贷款额度(单位:万)',width : parseInt($(this).width()*0.08)},
					              {field : 'loanMin',title : '最低接受额度(单位:万)',width : parseInt($(this).width()*0.08)},
					              {field : 'loanPeriod',title : '申请贷款期限',width : parseInt($(this).width()*0.1)},
					              {field : 'repayMethod',title : '还款方式',width : parseInt($(this).width()*0.1)},
					              {field : 'purpose',title : '贷款用途',width : parseInt($(this).width()*0.1)},
					              {field : 'orderStatus',title : '订单状态',width : parseInt($(this).width()*0.1),
					            	  formatter: function(value,row,index){
											return value.statusName;
					            	  }
					              }, 
					              {field : 'operate',title : '操作',width : parseInt($(this).width()*0.2),
					            	  formatter: function(value,row,index){
		      							var result =  "<a href='javascript:void(0);' onclick='lookLoanOrderProcessCommentDialog("+index+");'>查看审批意见</a>　　";
		      							result +="<a href='javascript:void(0);' onclick='showImage("+index+");'>查看审批流程</a>　　";
		      							result +="<a href='javascript:void(0);' onclick='claimTask("+index+");'>签收任务</a>";
		      							return result;
					      			}
					              }
					              ] ],toolbar:'#tb'
				});
			});
		
		// 基本函数的操作
		function getRowData(index) {
	        if (!$.isNumeric(index) || index < 0) { return undefined; }
	        var rows = $dg.datagrid("getRows");
	        return rows[index];
	    }
	    
		// 查看流程图片
		function  showImage(index) {
			var row = this.getRowData(index);
			var src = "loanOrder/loanOrderAction!getDiagramResourceByTaskId.action?taskId="
					+ row.taskId;
			$('#imageDialog').dialog("open");
			$("#image").attr("src", src);
		}
	    
		// 领取任务
		function claimTask(index) {
			var row = this.getRowData(index);
			$.ajax({
				url : "loanOrder/loanOrderAction!saveClaimTask.action",
				data : {"taskId" : row.taskId},
				success : function(rsp) {
					if(rsp.status){
						parent.$.messager.show({
							title : rsp.title,
							msg : rsp.message,
							timeout : 1000 * 2
						});
					}else{
						parent.$.messager.alert(rsp.title,rsp.message,'warning');
					}
					$dg.datagrid('reload')
				}
			});
		}
		
		// 查看流程批注
		function lookLoanOrderProcessCommentDialog(index) {
			var row = this.getRowData(index);
			parent.$.modalDialog.openner= $grid;
			parent.$.modalDialog({
				title : '审批意见查看',
				width : 1000,
				height : 650,
				href : "jsp/loanOrder/loanOrderProcessComment.jsp"});
		}
	</script>
  </head>
  <body>
      <div data-options="region:'center',border : false">
  		<div class="well well-small" style="margin-left: 5px;margin-top: 5px">
				业务管理-->贷款业务管理-->代办任务
		</div>
		<table id="dg"></table>
	    <div id="imageDialog" class="easyui-dialog" title="流程图片" data-options="border:false,closed:true,fit:true">
			<img id="image" src="" >
		</div>
  	</div>	
  </body>
</html>
