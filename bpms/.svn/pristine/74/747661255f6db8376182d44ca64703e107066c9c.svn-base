package com.bpms.util;

import java.io.File;
import java.io.IOException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Properties;
import java.util.Random;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;

import com.sun.jersey.api.client.Client;
import com.sun.jersey.api.client.UniformInterfaceException;
import com.sun.jersey.api.client.WebResource;

/**
 * 
 * 往远程服务器系统保存上传文件.
 * 
 */
public class SaveUploadFileUtil {

	/** 文件的名称. */
	private static final String PROPERTIES_NAME = "filesys.properties";

	/** Properties工具类. */
	private static Properties pro = new Properties();

	/**
	 * 无参数的构造方法,限定工具类,不能进行创建实例
	 */
	private SaveUploadFileUtil() {
	}

	/** 加载配置文件. */
	static {
		try {
			pro.load(SaveUploadFileUtil.class.getClassLoader().getResourceAsStream(PROPERTIES_NAME));
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	/** 文件系统外网访问URL KEY. */
	private static final String KEY_FILE_SYSTEM_EXTRANET_URL = pro
			.getProperty("file_system_extranet_url");
	
	/** 文件系统内网访问URL KEY. */
	private static final String KEY_FILE_SYSTEM_INTRANET_URL = pro
			.getProperty("file_system_intranet_url");

	/** 文件系统端口 KEY. */
	private static final String KEY_FILE_SYSTEM_PORT = pro
			.getProperty("file_system_port");

	/** 文件系统APP名称 KEY. */
	private static final String KEY_FILE_SYSTEM_NAME = pro
			.getProperty("file_system_name");

	/** 请求路径中的分割线。 */
	private static final String KEY_FORWARD = "/";

	/**
	 * 文件服务器的外网访问地址
	 */
	public static String getFileSystemExtranetURL() {
		StringBuffer url = new StringBuffer();
		url.append(KEY_FILE_SYSTEM_EXTRANET_URL);
		url.append(":");
		url.append(KEY_FILE_SYSTEM_PORT);
		url.append(KEY_FORWARD);
		url.append(KEY_FILE_SYSTEM_NAME);
		url.append(KEY_FORWARD);
		return url.toString();
	}
	
	/**
	 * 文件服务器的内网地址
	 */
	public static String getFileSystemIntranetURL() {
		StringBuffer url = new StringBuffer();
		url.append(KEY_FILE_SYSTEM_INTRANET_URL);
		url.append(":");
		url.append(KEY_FILE_SYSTEM_PORT);
		url.append(KEY_FORWARD);
		url.append(KEY_FILE_SYSTEM_NAME);
		url.append(KEY_FORWARD);
		return url.toString();
	}

	/**
	 * 将文件按保存到文件服务器并返回文件相对路径名称(最初的版本,已经舍弃)
	 */
	public static String saveFile2FileSystem(String fileName, File file) {
		String ext = FilenameUtils.getExtension(fileName);
		String fileNewName = getFileNewName();
		String path = fileNewName + "." + ext;
		String url = getFileSystemIntranetURL() + path;
		try {
			getJerseyClient(url).put(String.class,FileUtils.readFileToByteArray(file));
		} catch (UniformInterfaceException | IOException e) {
			e.printStackTrace();
		}
		return path;
	}

	/**
	 * 对于贷款业务：将文件按保存到文件服务器并返回文件相对路径名称(新的保存附件的方法)
	 */
	public static String saveFile2FileSystem4LoanOrder(String loanOrderId, String fileName, File file) {
		String ext = FilenameUtils.getExtension(fileName);
		String fileNewName = getFileNewName();
		//定义发起RestFul风格请求的逻辑URL路径。
		String path = "resources/loanAttachment/" + loanOrderId + "/" + fileNewName + "." + ext;
		String url = getFileSystemIntranetURL() + path;
		try {
			getJerseyClient(url).put(String.class,FileUtils.readFileToByteArray(file));
			//返回图片实际存储的物理路径（注意区别：图片的逻辑URL路径比图片的实际物理路径多了一个“resources”字符串）。
			path = path.replace("resources/", "");			
		} catch (UniformInterfaceException | IOException e) {
			e.printStackTrace();
		}
		return path;
	}	
	
	
	/**
	 * 对于投资业务：将文件按保存到文件服务器并返回文件相对路径名称(新的保存附件的方法)
	 */
	public static String saveFile2FileSystemForInvestOrder(String investOrderId, String fileName, File file) {
		String ext = FilenameUtils.getExtension(fileName);
		String fileNewName = getFileNewName();
		//定义发起RestFul风格请求的逻辑URL路径。
		String path = "resources/investAttachment/" + investOrderId + "/" + fileNewName + "." + ext;
				
		String url = getFileSystemIntranetURL() + path;
		try {
			getJerseyClient(url).put(String.class, FileUtils.readFileToByteArray(file));
			//返回图片实际存储的物理路径（注意区别：图片的逻辑URL路径比图片的实际物理路径多了一个“resources”字符串）。
			path = path.replace("resources/", "");
		} catch (UniformInterfaceException | IOException e) {
			e.printStackTrace();
		}
		return path;
	}
			
	
	/**
	 * 将文件按保存到文件服务器并返回文件相对路径名称
	 */
	public static String saveSwf2FileSystem(String fileName, File file) {
		String url = getFileSystemIntranetURL() + fileName;
		try {
			getJerseyClient(url).put(String.class,FileUtils.readFileToByteArray(file));
		} catch (UniformInterfaceException | IOException e) {
			e.printStackTrace();
		}
		return fileName;
	}

	/**
	 * 从服务器上获取文件
	 * 
	 * @param path
	 *            文件的路径
	 */
	public static File getFileFormFileSystemByPath(String path) {
		return getJerseyClient(getFileSystemIntranetURL() + path).get(File.class);
	}

	/**
	 * 根据文件的路径获取文件字节信息
	 * 
	 * @param path
	 *            文件的路径
	 */
	public static byte[] getBytesFormFileSystemByPath(String path) {
		return getJerseyClient(getFileSystemIntranetURL() + path).get(byte[].class);
	}

	/**
	 * 获取jersey的客户端
	 */
	private static WebResource getJerseyClient(String url) {
		return new Client().resource(url);
	}

	/**
	 * 删除服务器上的图片文件
	 */
	public static void deleteFlieSystemFileByPath(String path) {
		getJerseyClient(getFileSystemIntranetURL() + path).delete();
	}

	/**
	 * 获取文件新名称，防止服务器文件名重复
	 */
	private static String getFileNewName() {
		DateFormat df = new SimpleDateFormat("yyyyMMddHHmmssSSS");
		String fileName = df.format(new Date());
		Random random = new Random(System.currentTimeMillis());
		for (int j = 0; j < 5; j++) {
			fileName += random.nextInt(10);
		}
		return fileName;
	}
}
