package com.bpms.action;

import java.lang.reflect.InvocationTargetException;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.beanutils.PropertyUtils;
import org.apache.struts2.convention.annotation.Action;
import org.apache.struts2.convention.annotation.Namespace;
import org.springframework.beans.factory.annotation.Autowired;

import com.bpms.model.LoanCustRepaymentDetail;
import com.bpms.model.vo.CustomerRepaymentInfoModel;
import com.bpms.model.vo.LoanCustRepaymentDetailModel;
import com.bpms.service.CommonService;
import com.bpms.service.LoanCustRepaymentDetailService;
import com.bpms.util.Collections;
import com.bpms.util.PageUtil;
import com.bpms.view.model.DataModel;
import com.bpms.view.model.GridModel;
import com.opensymphony.xwork2.ModelDriven;

/**
 * 客户贷款信息详情控制器
 * @author Sun
 *
 */
@Namespace("/loanCustRepaymentDetail")
@Action(value = "loanCustRepaymentDetailAction")
public class LoanCustRepaymentDetailAction extends BaseAction implements ModelDriven<LoanCustRepaymentDetail>{

	private static final long serialVersionUID = -8874867334416868041L;
	private LoanCustRepaymentDetail loanCustRepaymentDetail = new LoanCustRepaymentDetail();
	
	@Autowired
	private LoanCustRepaymentDetailService loanCustRepaymentDetailService;

	@Autowired
	private CommonService commonService;
	
	@Override
	public LoanCustRepaymentDetail getModel() {
		return loanCustRepaymentDetail;
	}
	
	private String organizationId;
	private String loanName;
	private String contractSignDateS;
	private String contractSignDateE;
	private String repaymentBgDate;
	private String repayAmt;//还款金额

	public void findLoanCustRepaymentDetail(){
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("organizationId", organizationId);
		map.put("loanName", loanName);
		map.put("contractNo", loanCustRepaymentDetail.getContractNo());
		map.put("contractSignDateS", contractSignDateS);
		map.put("contractSignDateE", contractSignDateE);
		map.put("repaymentBgDate", repaymentBgDate);
		List<CustomerRepaymentInfoModel> list = loanCustRepaymentDetailService.findLoanCustRepaymentDetail(map, new PageUtil(page,rows));
		GridModel gridModel = new GridModel();
		gridModel.setRows(list);
		gridModel.setTotal(loanCustRepaymentDetailService.getCountoFLoanCustRepaymentDetail(map));
		OutputJson2(gridModel);
	}
	
	public void findRepaymentDetailByCno(){
		GridModel gridModel = new GridModel();
		Map<String,Object> map = new HashMap<String,Object>();
		map.put("contractNo",loanCustRepaymentDetail.getContractNo());
		List<LoanCustRepaymentDetail> list = loanCustRepaymentDetailService.findRepaymentDetailByCno(map, new PageUtil(page,rows));
		List<LoanCustRepaymentDetailModel> lists = new ArrayList<LoanCustRepaymentDetailModel>();
		if(Collections.listIsNotEmpty(list)){
			for(LoanCustRepaymentDetail lcr: list){
				LoanCustRepaymentDetailModel lcrdm = new LoanCustRepaymentDetailModel();
				try {
					PropertyUtils.copyProperties(lcrdm, lcr);
				} catch (IllegalAccessException | InvocationTargetException
						| NoSuchMethodException e) {
					e.printStackTrace();
				}
				lcrdm.setRpmtStatusName(commonService.findDictName("repmt_status", lcr.getRpmtStatus()));
				lists.add(lcrdm);
			}
		}
		gridModel.setRows(lists);
		gridModel.setTotal(loanCustRepaymentDetailService.getCountRepaymentDetail(map));
		OutputJson2(gridModel);
	}
	
	public void  exportLoanCustRepaymentDetail(){
		try {
			this.loanCustRepaymentDetailService.exportLoanCustRepaymentDetail();
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	//还款
	public void repaymentSave(){
		LoanCustRepaymentDetail lcrd = loanCustRepaymentDetailService.findCustRepaymentDeatilById(loanCustRepaymentDetail.getRdId());
		BigDecimal repayAmts = new BigDecimal(repayAmt);
		lcrd.setRealRepmtAmt(lcrd.getRealRepmtAmt().add(repayAmts));
		lcrd.setRpmtStatus("1");
		if(lcrd.getRealRepmtAmt().subtract(lcrd.getPlanRepmtAmt()).doubleValue()>=0){
			lcrd.setRpmtStatus("2");
		}
		if(lcrd.getPlanRepmtDate().before(new Date())){
			lcrd.setRpmtStatus("3");
		}
		lcrd.setRepmtAct(loanCustRepaymentDetail.getRepmtAct());
		Boolean b = loanCustRepaymentDetailService.persistenceLoanCustRepaymentDetail(lcrd);
		String msg = "保存失败";
		if(b){
			msg = "保存成功";
		}
		OutputJson(new DataModel("还款详情", msg, b, lcrd));
	}
	
	public LoanCustRepaymentDetail getLoanCustRepaymentDetail() {
		return loanCustRepaymentDetail;
	}
	public void setLoanCustRepaymentDetail(
			LoanCustRepaymentDetail loanCustRepaymentDetail) {
		this.loanCustRepaymentDetail = loanCustRepaymentDetail;
	}
	public String getOrganizationId() {
		return organizationId;
	}


	public void setOrganizationId(String organizationId) {
		this.organizationId = organizationId;
	}


	public String getLoanName() {
		return loanName;
	}


	public void setLoanName(String loanName) {
		this.loanName = loanName;
	}


	public String getContractSignDateS() {
		return contractSignDateS;
	}


	public void setContractSignDateS(String contractSignDateS) {
		this.contractSignDateS = contractSignDateS;
	}


	public String getContractSignDateE() {
		return contractSignDateE;
	}


	public void setContractSignDateE(String contractSignDateE) {
		this.contractSignDateE = contractSignDateE;
	}


	public String getRepaymentBgDate() {
		return repaymentBgDate;
	}


	public void setRepaymentBgDate(String repaymentBgDate) {
		this.repaymentBgDate = repaymentBgDate;
	}

	public String getRepayAmt() {
		return repayAmt;
	}

	public void setRepayAmt(String repayAmt) {
		this.repayAmt = repayAmt;
	}
	
	
}
