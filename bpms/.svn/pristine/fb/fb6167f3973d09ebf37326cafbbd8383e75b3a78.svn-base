//渲染单位地址datagrid
var corpNatureData = jqueryUtil.getTextArr("corp_nature");
function initDatagrid(){
	$("#dwDatagrid").datagrid({
		url : "company/companyAction!findListByLoanerId.action",
		width : 863,
		height : 360,
		pagination:false,
		rownumbers:true,
		border:true,
		singleSelect:false,
		nowrap:true,
		multiSort:false,
		columns : [ [
                     {field : 'ck',rowspan:2,checkbox : true},
		             {field : 'name',title : '单位名称',width : 80,rowspan:2,align : 'center'},
		             {field : 'tele',title : '单位电话',width : 80,rowspan:2,align : 'center'},
		             {field : 'corpNature',title : '单位性质',width : 140,rowspan:2,align : 'center',formatter:function(value,row,index){
						 return jqueryUtil.showText(value,corpNatureData);
					 	}
		             },
		             {field : 'foundedTime',title : '成立时间',width : 150,rowspan:2,align : 'center',formatter:function(value,row,index){
		            	 if(null!=value){
		            		  var date = new Date(value);
		            		  return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
		            	  }
		            	  return " ";
		             }},
		             {field : 'regCapital',title : '注册资本',width : 150,rowspan:2,align : 'center'},
		             {field : 'areaSize',title : '营业面积',width : 150,rowspan:2,align : 'center'},
		             {field : 'empAmount',title : '员工数量',width : 150,rowspan:2,align : 'center'},
		             {title : '单地址位',width : 340,colspan:4,align : 'center'}
		],[
					 {field : 'dwProvince',title : '省',width : 80,align : 'center',formatter:function(value,row,index){
						 return jqueryUtil.showText(value,provinceArr);
					 }},
					 {field : 'dwCity',title : '市',width : 80,align : 'center',formatter:function(value,row,index){
						 var cityArr = jqueryUtil.getAreaTextArr(row.dwProvince);
						 return jqueryUtil.showText(value,cityArr);
					 }},
					 {field : 'dwArea',title : '县/区',width : 80,align : 'center',formatter:function(value,row,index){
						 var areaArr = jqueryUtil.getAreaTextArr(row.dwCity);
						 return jqueryUtil.showText(value,areaArr);
					 }},
					 {field : 'dwAddrDetails',title : '详细地址',width : 200,align : 'center'}
		]],
		toolbar: [{
			iconCls: 'icon-edit',
			text:'编辑',
			handler: doEditDw
		},"-",{
			iconCls: 'icon-cut',
			text:'删除',
			handler: doDeleteDw
		},'-',{
			iconCls: 'icon-save',
			text:'保存',
			handler: doSaveDw
		}],
		onLoadSuccess:function(data){
            if(data.total==0){
                var dc = $(this).data('datagrid').dc;
                var header2Row = dc.header2.find('tr.datagrid-header-row');
                dc.body2.find('table').append(header2Row.clone().css({"visibility":"hidden"}));
            }
        }
	});
}
//新增保存单位
function toSaveDw(){
	//客户基本信息是否保存的标志
	var $sign = $("#sign").val();
	if("edit" == $sign){
		$.messager.alert("提示","请您填写客户基本资料并保存!","warning");
		return;
	}
	var isValid = $("#dwform").form('validate');
	if(!isValid){
		return false;
	}
	//贷款人客户id
	var $loanerId = $("#loanerId").val();
	//发送请求保存紧急联系人
	$.ajax({
		cache: true,
		type: "POST",
		url:"company/companyAction!saveCompany.action?loanerId="+$loanerId,
		data:$('#dwform').serialize(),
		async: false,
	    error: function(request) {
	        alert("Connection error");
	    },
	    success: function(iJson) {
	    	var res = JSON.parse(iJson);
			if(res.state){
				$("#dwDatagrid").datagrid('reload',{loanerId:$loanerId});//刷新列表
				$('#dwform').form('clear');//清空form表单
			}
			parent.$.messager.show({
				title : '提示',
				msg : res.msg,
				timeout : 4000 * 2
			});
	    }
	});
}
//保存订单与工作单位关系
function doSaveDw(){
	//客户基本信息是否保存的标志
	var $sign = $("#sign").val();
	if("edit" == $sign){
		$.messager.alert("提示","请您填写客户基本资料并保存!","warning");
		return;
	}
	//订单id
	var $loanOrderId = $("#loanOrderId").val();
	var row = $("#dwDatagrid").datagrid("getSelected");
	var rows = $('#dwDatagrid').datagrid('getSelections');
	if (row == null) {
		$.messager.alert("提示", "请至少勾选一条记录作为本次借款的工作单位!", "warning");
		return;
	}
	var ids = new Array();
	for(var i=0;i<rows.length;i++){
		ids.push(rows[i].comId);
	}
	ids=ids.join(","); 
	$.ajax( {
		type : "POST",
		url : 'loanorderAndCompany/loanorderAndCompanyAction!saveLoanorderAndCompany.action',
		data: "comIds="+ids+"&loanOrderId="+$loanOrderId,
		dataType:'json',
		success : function(iJson) {
			var res = JSON.parse(iJson);
			parent.$.messager.show({
				title : '提示',
				msg : res.msg,
				timeout : 4000 * 2
			});
		}
	});
}
//编辑
function doEditDw(){
	//客户基本信息是否保存的标志
	var $sign = $("#sign").val();
	if("edit" == $sign){
		$.messager.alert("提示","请您填写客户基本资料并保存!","warning");
		return;
	}
	var row = $("#dwDatagrid").datagrid("getSelected");
	var rows = $('#dwDatagrid').datagrid('getSelections');
	if (row == null) {
		$.messager.alert("提示", "请选择一条记录进行编辑!", "warning");
		return;
	}
	if(rows.length >1){
		$.messager.alert("提示", "您只能选择一条记录执行编辑!", "warning");
		return;
	}
	//获取订单id
	var $loanOrderId = $("#loanOrderId").val();
	$.ajax( {
		type : "POST",
		url : 'company/companyAction!doEdit.action',
		data : "comId="+row.comId+"&loanOrderId="+$loanOrderId,
		dataType:'JSON',
		success : function(iJson) {
			console.info(iJson);
			var res = JSON.parse(iJson);
			if(res.state){
				$("#dwform").form('load',row);
				//渲染市区
		        renderCitySelect('dwCity','dwArea',row.dwProvince);
		        $("#dwCity").combobox("setValue",row.dwCity);
		        $("#dwArea").combobox("setValue",row.dwArea);
			}else{
				parent.$.messager.show({
					title : '提示',
					msg : res.msg,
					timeout : 4000 * 2
				});
			}
		}
	});
}
//删除
function doDeleteDw(){
	//客户基本信息是否保存的标志
	var $sign = $("#sign").val();
	if("edit" == $sign){
		$.messager.alert("提示","请您填写客户基本资料并保存!","warning");
		return;
	}
	//获取订单id
	var $loanOrderId = $("#loanOrderId").val();
	var selected = $('#dwDatagrid').datagrid('getSelections');
	if (selected.length <= 0) {
		$.messager.alert("提示", "请至少选择一条记录执行删除!", "warning");
		return;
	}
	var ids = new Array();
	for(var i=0,len=selected.length; i<len; i++){
		ids.push(selected[i].comId);
	}
	ids = ids.join(",");
	$.messager.confirm('删除', '执行删除后，数据将不可恢复,是否执行?', function(d) {
		if (d) {
			$.ajax( {
				type : "POST",
				url : 'company/companyAction!doDeleteById.action',
				data : "comIds="+ids+"&loanOrderId="+$loanOrderId,
				dataType:'JSON',
				success : function(iJson) {
					console.info(iJson);
					var res = JSON.parse(iJson);
					if(res.state){
						//贷款人客户id
						var $loanerId = $("#loanerId").val();
						//刷新列表
						$("#dwDatagrid").datagrid("reload",{loanerId:$loanerId});
					}
					parent.$.messager.show({
						title : '提示',
						msg : res.msg,
						timeout : 4000 * 2
					});
				}
			});
		}
	});
}