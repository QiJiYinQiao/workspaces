var provinceArr = jqueryUtil.getAreaTextArr(1);//获取省
var relationshipArr = jqueryUtil.getTextArr("relationship_type"); //与本人关系
//渲染紧急联系人列表
function linkPeopleDatagrid() {
	$("#linkPeople").datagrid({
			width : 863,
			height : 290,
			pagination : false,
			rownumbers : true,
			border : true,
			singleSelect : false,
			nowrap : true,
			multiSort : false,
			columns : [[
						{field : 'ck',rowspan : 2,checkbox : true},
						{field : 'chName',title : '姓名',width : 80,rowspan : 2,align : 'center'},
						{field : 'relationship',title : '与本人关系',width : 80,rowspan : 2,align : 'center',
							formatter : function(value,row, index) {
								return jqueryUtil.showText(value,relationshipArr);
							}
						},
						{field : 'tel',title : '手机',width : 140,rowspan : 2,align : 'center'},
						{field : 'workplace',title : '工作单位',width : 150,rowspan : 2,align : 'center'},
						{title : '单地址位',width : 340,colspan : 4,align : 'center'} ],
					[
						{field : 'compProvince',title : '省',width : 80,align : 'center',
							formatter : function(value,row, index) {
								return jqueryUtil.showText(value, provinceArr);
							}
						},
						{field : 'compCity',title : '市',width : 80,align : 'center',
							formatter : function(value,row, index) {
								var cityArr = jqueryUtil.getAreaTextArr(row.compProvince);
								return jqueryUtil.showText(value, cityArr);
							}
						},
						{field : 'compArea',title : '县/区',width : 80,align : 'center',
							formatter : function(value,row, index) {
								var areaArr = jqueryUtil.getAreaTextArr(row.compCity);
								return jqueryUtil.showText(value, areaArr);
							}
						},
						{field : 'compAddrDetails',title : '详细地址',width : 200,align : 'center'}
					] ],
			toolbar : [ {
				iconCls : 'icon-edit',
				text : '编辑',
				handler : doEdit
			}, "-", {
				iconCls : 'icon-cut',
				text : '删除',
				handler : doDelete
			}, '-', {
				iconCls : 'icon-save',
				text : '保存',
				handler : doSave
			} ],
			onLoadSuccess : function(data) {
				for (var i = 0; i < data.rows.length; i++) {
					if ("checked" == data.rows[i].checkedLinkMan) {
						$("#linkPeople").datagrid("selectRow",i);
					}
				}
			}
	});
}
//新增紧急联系人
function toSaveLinkPeople(){
	//客户基本信息是否保存的标志
	if(!checkIsSaveLoaner()) return false;
	if(!$("#LinkPeopleForm").form('validate')){return false;}
	//贷款人客户id
	var $loanerId = $("#loanerId").val();
	$("#cusId").val($loanerId);
	//发送请求保存紧急联系人
	$.ajax({
		cache: true,
		type: "POST",
		url:"contacts/contactsAction!saveContacts.action",
		data:$('#LinkPeopleForm').serialize(),
		async: false,
	    error: function(request) {
	        alert("Connection error");
	    },
	    success: function(res) {
	    	if(res.status){
	    		$("#LinkPeopleForm").form('clear');
	    		$("#LinkPeopleForm input[name='idType']").val("A");
	    		
		    	$("#linkPeople").datagrid("reload",{loanerId:$loanerId});
	    	}
	    	parent.$.messager.show({
				title : '提示',
				msg : res.message,
				timeout : 4000 * 2
			});
	    }
	});
}
//选择紧急联系人，作为本次借款的联系人
function doSave(){
	//客户基本信息是否保存的标志
	if(!checkIsSaveLoaner()) return false;
	//订单id
	var $loanOrderId = $("#loanOrderId").val();
	var row = $("#linkPeople").datagrid("getSelected");
	var selected = $('#linkPeople').datagrid('getSelections');
	if (row == null) {
		$.messager.alert("提示", "请至少勾选一个联系人作为本次借款的紧急联系人!", "warning");
		return;
	}
	var ids = new Array();
	for(var i=0;i<selected.length;i++){
		ids.push(selected[i].contactId);
	}
	ids=ids.join(","); 
	$.ajax( {
		type : "POST",
		url : 'loanorderAndContacts/loanorderAndContactsAction!saveLoanorderAndContacts.action',
		data: "contactIds="+ids+"&loanOrderId="+$loanOrderId,
		dataType:'json',
		success : function(iJson) {
			var res = JSON.parse(iJson);
			parent.$.messager.show({
				title : '提示',
				msg : res.msg,
				timeout : 4000 * 2
			});
		}
	});
}
//紧急联系人删除
function doDelete(){
	//客户基本信息是否保存的标志
	if(!checkIsSaveLoaner()) return false;
	//获取订单id
	var $loanOrderId = $("#loanOrderId").val();
	var selected = $('#linkPeople').datagrid('getSelections');
	if (selected.length <= 0) {
		$.messager.alert("提示", "请至少选择一条记录执行删除!", "warning");
		return;
	}
	var ids = new Array();
	for(var i=0,len=selected.length; i<len; i++){
		ids.push(selected[i].contactId);
	}
	ids = ids.join(",");
	$.messager.confirm('删除', '执行删除后，数据将不可恢复,是否执行?', function(d) {
		if (d) {
			$.ajax( {
				type : "POST",
				url : 'contacts/contactsAction!doDeleteById.action',
				data : "contactIds="+ids+"&loanOrderId="+$loanOrderId,
				dataType:'JSON',
				success : function(iJson) {
					var res = JSON.parse(iJson);
					if(res.state){
						//贷款人客户id
						var $loanerId = $("#loanerId").val();
						//刷新列表
						$("#linkPeople").datagrid("reload",{loanerId:$loanerId});
					}
					parent.$.messager.show({
						title : '提示',
						msg : res.msg,
						timeout : 4000 * 2
					});
				}
			});
		}
	});
}
//编辑紧急联系人
function doEdit(){
	//客户基本信息是否保存的标志
	if(!checkIsSaveLoaner()) return false;
	var row = $("#linkPeople").datagrid("getSelected");
	var rows = $('#linkPeople').datagrid('getSelections');
	if (row == null) {
		$.messager.alert("提示", "请选择一条记录进行编辑!", "warning");
		return;
	}
	if(rows.length >1){
		$.messager.alert("提示", "您只能选择一条记录执行编辑!", "warning");
		return;
	}
	//获取订单id
	var $loanOrderId = $("#loanOrderId").val();
	$.ajax( {
		type : "POST",
		url : 'contacts/contactsAction!doEdit.action',
		data : "contactId="+row.contactId+"&loanOrderId="+$loanOrderId,
		dataType:'JSON',
		success : function(iJson) {
			console.info(iJson);
			var res = JSON.parse(iJson);
			if(res.state){
				$("#LinkPeopleForm").form('load',row);
				//渲染市区
		        renderCitySelect('compCity','compArea',row.compProvince);
		        renderCitySelect('familyCity','familyArea',row.familyProvince);
		        $("#compCity").combobox("setValue",row.compCity);
		        $("#compArea").combobox("setValue",row.compArea);
		        $("#familyCity").combobox("setValue",row.familyCity);
		        $("#familyArea").combobox("setValue",row.familyArea);
			}else{
				parent.$.messager.show({
					title : '提示',
					msg : res.msg,
					timeout : 4000 * 2
				});
			}
		}
	});
}